@using System.Diagnostics.CodeAnalysis
@using System.Text
@using Arkanis.Overlay.Domain.Abstractions.Game
@using Arkanis.Overlay.External.MedRunner.API
@using Arkanis.Overlay.External.MedRunner.API.Endpoints.Emergency.Request
@using Arkanis.Overlay.External.MedRunner.Models
@using Arkanis.Overlay.Infrastructure.Helpers
@inherits MedRunnerComponentBase

<MudGrid Class="pa-5">
    <MudItem xs="12" md="8">
        <GameEntitySelectBox
            Label="Closest location"
            EntityCategory="@GameEntityCategory.Location"
            @bind-Value="@_closestLocationEntity"
            Accept="@(location => location is not GameStarSystem)"/>
    </MudItem>
    <MudItem xs="12" md="4">
        <MudSelect @bind-Value="@_threatLevel"
                   Label="Threat level">
            @foreach (var threatLevel in Enum.GetValues<ThreatLevel>())
            {
                <MudSelectItem T="ThreatLevel?" Value="@threatLevel">
                    @threatLevel.Humanize()
                </MudSelectItem>
            }
        </MudSelect>
    </MudItem>
    <MudItem xs="12">
        <MudAlert Severity="@Severity.Info">
            By submitting this request, you agree to the
            <MudLink Href="@ExternalLinkHelper.GetMedRunnerTosLink(ContentId)"
                     Target="_blank"
                     Typo="@Typo.inherit">
                terms and conditions
            </MudLink>
            of the service provider.
        </MudAlert>
    </MudItem>
    <MudItem xs="12">
        <MudButton Variant="@Variant.Filled"
                   Color="@Color.Error"
                   Class="w-100"
                   StartIcon="@Icons.Material.Filled.EmergencyShare"
                   OnClick="@StartMedRunnerEmergencyAsync"
                   Disabled="@SubmitDisabled">
            Submit request
        </MudButton>
        @if (Context.HasErrors)
        {
            <MudStack Class="mt-2">
                @foreach (var error in Context.Errors)
                {
                    <MudAlert Severity="@Severity.Error">
                        @error
                    </MudAlert>
                }
            </MudStack>
        }
    </MudItem>
</MudGrid>

@code
{

    private ThreatLevel? _threatLevel;
    private IGameEntity? _closestLocationEntity;

    private GameLocationEntity? ClosestLocation
        => _closestLocationEntity as GameLocationEntity;

    [MemberNotNullWhen(false, nameof(ClosestLocation), nameof(_threatLevel))]
    private bool SubmitDisabled
        => IsLoading
           || ClosestLocation is null
           || _threatLevel is null;

    private async Task StartMedRunnerEmergencyAsync()
    {
        if (SubmitDisabled)
        {
            return;
        }

        await PerformSafeAsync(async () =>
            {
                var request = new CreateEmergencyRequest
                {
                    Location = CreateMedRunnerLocation(ClosestLocation),
                    ThreatLevel = _threatLevel.Value,
                };
#if DEBUG
                await Task.Delay(TimeSpan.FromMilliseconds(100));
                var emergencyResponse = new ApiResponse<Emergency>
                {
                    Data = new Emergency
                    {
                        Id = Guid.NewGuid().ToString(),
                        System = request.Location.System,
                        Subsystem = request.Location.Subsystem,
                        ClientRsiHandle = Context.ClientInfo?.RsiHandle ?? "unknown",
                        SubscriptionTier = "basic",
                        Status = MissionStatus.Accepted,
                        AcceptedTimestamp = DateTimeOffset.Now.ToUnixTimeSeconds(),
                        RespondingTeam = new RespondingTeam
                        {
                            Id = Guid.NewGuid().ToString(),
                            Name = "Flying Dutchman",
                        },
                        RespondingTeams =
                        [
                            new RespondingTeam
                            {
                                Id = Guid.NewGuid().ToString(),
                                Name = "Flying Dutchman",
                            },
                        ],
                        CreationTimestamp = DateTimeOffset.Now.ToUnixTimeSeconds(),
                    },
                    Success = true,
                };
#else
                //var emergencyResponse = await MedRunner.Emergency.CreateEmergencyAsync(request);
#endif
                if (!emergencyResponse.Success)
                {
                    Context.Errors.Add(emergencyResponse.ErrorMessage);
                    await ContextChanged.InvokeAsync(Context);
                    return;
                }

                Context.Emergency = emergencyResponse.Data;
                await ContextChanged.InvokeAsync(Context);
            }
        );
    }

    private Location CreateMedRunnerLocation(GameLocationEntity location)
        => new()
        {
            System = location.CreatePathToRoot().OfType<GameStarSystem>().First().Name.MainContent.FullName,
            Subsystem = location.CreatePathToRoot().OfType<GamePlanet>().First().Name.MainContent.FullName,
            TertiaryLocation = new StringBuilder().AppendJoin(
                    " / ",
                    location.CreatePathToRoot()
                        .Reverse()
                        .Where(x => x is not GameStarSystem and not GamePlanet)
                        .Select(x => x.Name.MainContent.FullName)
                        .Append(location.Name.MainContent.FullName)
                )
                .ToString(),
        };

}
