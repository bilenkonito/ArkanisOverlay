@using Arkanis.Overlay.External.MedRunner.Models
@inherits MedRunnerComponentBase

<MudStack Class="pa-5">
    @if (Context.Emergency is not null)
    {
        <MudToggleGroup @bind-Value="@Context.Emergency.Rating"
                        Color="@ColorByResponseRating"
                        FixedContent
                        CheckMark>
            <MudToggleItem SelectedIcon="@Icons.Material.Filled.ThumbUp"
                           Value="@ResponseRating.Good">
                Went well
            </MudToggleItem>
            <MudToggleItem SelectedIcon="@Icons.Material.Filled.ThumbsUpDown"
                           Value="@ResponseRating.None">
                No rating
            </MudToggleItem>
            <MudToggleItem SelectedIcon="@Icons.Material.Filled.ThumbDown"
                           Value="@ResponseRating.Bad">
                Went bad
            </MudToggleItem>
        </MudToggleGroup>
        <MudTextField
            T="string"
            Label="Response remarks"
            @bind-Value="@Context.Emergency.RatingRemarks"
            Class="review"
            Immediate
            AutoGrow/>
        <MudButton Variant="@(FeedbackProvided ? Variant.Outlined : Variant.Text)"
                   Color="@Color.Success"
                   OnClick="@SubmitReviewAsync"
                   StartIcon="@Icons.Material.Filled.Check"
                   Disabled="@IsLoading">
            Submit rating
        </MudButton>
    }
</MudStack>

@code
{

    private bool FeedbackProvided
        => Context.Emergency is null
           || Context.Emergency.Rating != ResponseRating.None
           || !string.IsNullOrWhiteSpace(Context.Emergency.RatingRemarks);

    public Color ColorByResponseRating
        => Context.Emergency?.Rating switch
        {
            ResponseRating.Good => Color.Success,
            ResponseRating.None => Color.Default,
            ResponseRating.Bad => Color.Error,
            _ => Color.Default,
        };

    private async Task SubmitReviewAsync()
    {
        if (Context.Emergency is null)
        {
            return;
        }

        await PerformSafeAsync(async () =>
            {
#if DEBUG
                await Task.Delay(TimeSpan.FromMilliseconds(250));
#else
                await MedRunner.Emergency.RateServicesAsync(EmergencyId, Context.Emergency.Rating, Context.Emergency.RatingRemarks);
#endif
                await ContextChanged.InvokeAsync(Context);
            }
        );
    }

}
